# 钉钉 OpenClaw Connector 开发规范

## 1. 代码风格指南

### 1.1 TypeScript 规范
- 使用 `const`/`let` 而非 `var`
- 类型注解必须明确，避免使用 `any`
- 接口命名使用 PascalCase（如 `UserSession`）
- 函数参数和返回值必须有类型注解
- 使用 `async/await` 而非回调函数

### 1.2 命名规范
- 变量和函数：camelCase（如 `getSessionKey`）
- 常量：UPPER_SNAKE_CASE（如 `MESSAGE_DEDUP_TTL`）
- 接口和类型：PascalCase（如 `FileInfo`）
- 枚举值：UPPER_SNAKE_CASE（如 `PROCESSING`）

### 1.3 注释规范
- 公共函数必须有 JSDoc 注释
- 复杂逻辑块需要行内注释说明
- TODO 注释格式：`// TODO: [描述] - [负责人/日期]`

## 2. 错误处理最佳实践

### 2.1 异常处理
- 所有异步操作必须包含 try-catch
- HTTP 请求必须处理网络错误和 API 错误
- 文件操作必须检查文件是否存在
- 错误信息必须包含上下文信息（如用户ID、消息ID）

### 2.2 日志记录
- 使用统一的日志前缀格式：`[DingTalk][模块名]`
- 关键操作必须记录 info 级别日志
- 错误必须记录 error 级别日志
- 调试信息使用 debug 级别（生产环境可关闭）

### 2.3 重试机制
- 网络请求失败应实现指数退避重试
- 重试次数限制为 3 次
- 重试间隔：1s, 2s, 4s

## 3. 安全注意事项

### 3.1 敏感信息处理
- AppKey 和 AppSecret 必须通过配置文件传入，不得硬编码
- 临时文件必须设置适当的权限（600）
- 敏感日志信息必须脱敏处理

### 3.2 输入验证
- 所有外部输入必须进行验证和清理
- 文件路径必须进行安全检查，防止路径遍历
- 消息内容必须进行 XSS 防护

### 3.3 权限控制
- 遵循最小权限原则
- 用户会话必须有超时机制
- 消息去重防止重复处理

## 4. 钉钉 API 使用规范

### 4.1 API 调用限制
- 遵守钉钉 API 调用频率限制
- 批量操作应使用钉钉提供的批量接口
- 长时间运行的操作应使用异步处理

### 4.2 消息格式
- Markdown 消息必须符合钉钉规范
- 图片消息必须提供有效的 media_id
- AI Card 消息必须包含正确的模板 ID

### 4.3 权限申请
- 必须申请必要的 API 权限：
  - `Card.Streaming.Write`
  - `Card.Instance.Write`  
  - `qyapi_robot_sendmsg`
  - `media/upload`

## 5. 测试要求

### 5.1 单元测试
- 核心函数必须有单元测试覆盖
- 边界条件必须进行测试
- 错误场景必须进行测试

### 5.2 集成测试
- Stream 连接必须进行端到端测试
- 消息处理流程必须进行集成测试
- 图片上传功能必须进行实际测试

### 5.3 性能测试
- 高并发场景下的性能表现
- 内存泄漏检测
- 长时间运行稳定性测试

## 6. 文档更新规则

### 6.1 代码变更
- 功能变更必须同步更新 README.md
- API 变更必须更新接口文档
- 配置项变更必须更新配置说明

### 6.2 版本发布
- 每次发布必须更新 CHANGELOG.md
- 重大变更必须在 release notes 中说明
- 向后不兼容的变更必须升级主版本号

### 6.3 示例更新
- 新功能必须提供使用示例
- 配置示例必须保持最新
- 截图必须反映最新 UI

## 7. 贡献指南

### 7.1 提交规范
- 提交信息格式：`类型: 描述`
- 类型包括：feat、fix、docs、style、refactor、test、chore
- 描述必须简洁明了，不超过 72 个字符

### 7.2 分支策略
- 主分支：`main`（受保护）
- 功能分支：`feature/功能名`
- 修复分支：`fix/问题描述`
- 发布分支：`release/vX.Y.Z`

### 7.3 代码审查
- 所有 PR 必须经过至少一人审查
- 复杂变更需要详细的设计说明
- 性能敏感的变更需要基准测试

## 8. 特殊功能规范

### 8.1 图片处理
- 本地图片路径自动上传功能
- 支持多种图片格式（png、jpg、jpeg、gif、bmp、webp）
- 文件大小限制：20MB
- 自动清理临时文件

### 8.2 会话管理
- 会话超时：默认 30 分钟
- 手动新会话命令：`/new`、`/reset`、`/clear`、`新会话`、`重新开始`、`清空对话`
- 会话状态持久化

### 8.3 主动消息
- 支持向个人和群组发送主动消息
- 支持多种消息类型（文本、Markdown、图片、文件、视频、音频）
- 支持 AI Card 和普通消息降级

## 9. 兼容性要求

### 9.1 Node.js 版本
- 最低支持：Node.js 16.x
- 推荐使用：Node.js 18.x 或更高

### 9.2 OpenClaw 版本
- 最低支持：OpenClaw 0.5.0
- 推荐使用：最新稳定版本

### 9.3 钉钉客户端
- 支持最新 3 个版本的钉钉客户端
- AI Card 功能需要钉钉 6.0+ 版本

## 10. 监控和告警

### 10.1 健康检查
- 定期检查 Stream 连接状态
- 监控 API 调用成功率
- 检测内存使用情况

### 10.2 告警阈值
- Stream 断开超过 5 分钟触发告警
- API 错误率超过 5% 触发告警
- 内存使用超过 80% 触发告警

### 10.3 日志收集
- 关键指标必须记录到结构化日志
- 错误堆栈必须完整记录
- 性能指标必须定期采样

---
**最后更新**: 2026-02-19  
**维护者**: Chengzheqiao  
**版本**: 1.0.0